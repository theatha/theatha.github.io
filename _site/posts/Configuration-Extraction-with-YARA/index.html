<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Configuration Extraction With Yara" />
<meta property="og:locale" content="en" />
<meta name="description" content="Introduction Hello everyone! Until seeing this blog from _n1ghtw0lf, I did not know that we can use YARA rules for configuration extraction. He wrote a YARA rule for dotnet samples using dotnet and a custom module. Then, it is inspired me to do the same thing for other kinds of samples besides samples that are written in dotnet. However, I could not find any module that gets the data at the given offset. Thus, I decided to write my own helper. Also, I will give an example YARA rule that uses this module to extract the Danabot sample’s configuration." />
<meta property="og:description" content="Introduction Hello everyone! Until seeing this blog from _n1ghtw0lf, I did not know that we can use YARA rules for configuration extraction. He wrote a YARA rule for dotnet samples using dotnet and a custom module. Then, it is inspired me to do the same thing for other kinds of samples besides samples that are written in dotnet. However, I could not find any module that gets the data at the given offset. Thus, I decided to write my own helper. Also, I will give an example YARA rule that uses this module to extract the Danabot sample’s configuration." />
<link rel="canonical" href="http://localhost:4000/posts/Configuration-Extraction-with-YARA/" />
<meta property="og:url" content="http://localhost:4000/posts/Configuration-Extraction-with-YARA/" />
<meta property="og:site_name" content="Theatha Technical Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-25T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Configuration Extraction With Yara" />
<meta name="twitter:site" content="@_theatha" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-25T00:00:00+08:00","datePublished":"2022-09-25T00:00:00+08:00","description":"Introduction Hello everyone! Until seeing this blog from _n1ghtw0lf, I did not know that we can use YARA rules for configuration extraction. He wrote a YARA rule for dotnet samples using dotnet and a custom module. Then, it is inspired me to do the same thing for other kinds of samples besides samples that are written in dotnet. However, I could not find any module that gets the data at the given offset. Thus, I decided to write my own helper. Also, I will give an example YARA rule that uses this module to extract the Danabot sample’s configuration.","headline":"Configuration Extraction With Yara","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Configuration-Extraction-with-YARA/"},"url":"http://localhost:4000/posts/Configuration-Extraction-with-YARA/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Configuration Extraction With Yara | Theatha Technical Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Theatha Technical Blog">
<meta name="application-name" content="Theatha Technical Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    
      <link rel="preconnect" href="https://polyfill.io" >
      <link rel="dns-prefetch" href="https://polyfill.io" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/favicons/chookity.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">Theatha Technical Blog</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">theatha</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/theatha"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/_theatha"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['theathax','protonmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/qkwvcvymsfwo/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Configuration Extraction With Yara</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Configuration Extraction With Yara</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1664035200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Sep 25, 2022
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/_theatha">Taha Y.</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="973 words"
>
  <em>5 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    
<h2 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Hello everyone! Until seeing <a href="https://n1ght-w0lf.github.io/tutorials/yara-for-config-extraction/">this blog</a> from <a href="https://twitter.com/_n1ghtw0lf">_n1ghtw0lf</a>, I did not know that we can use YARA rules for configuration extraction. He wrote a YARA rule for dotnet samples using dotnet and a custom module. Then, it is inspired me to do the same thing for other kinds of samples besides samples that are written in dotnet. However, I could not find any module that gets the data at the given offset. Thus, I decided to write my own helper. Also, I will give an example YARA rule that uses this module to extract the Danabot sample’s configuration.</p>

<h2 id="the-situation"><span class="me-2">The Situation</span><a href="#the-situation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>YARA is mostly aimed at helping people to classify the samples. Typically, researchers would use YARA to detect patterns and identify the sample then will progress with the configuration extraction scripts if they found a known malware. If you insist to use YARA to extract some valuable information from the samples, there are some modules that can help. However, they are not much efficent for configuration extraction. For example, let’s write a configuration extractor with YARA for the Danabot samples without modules. Try to understand YARA rule below;</p>
<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">import</span> <span class="s2">"console"</span>
<span class="n">rule</span> <span class="n">DanabotV1_Config_Extraction</span> <span class="p">{</span>
    <span class="n">meta</span><span class="o">:</span>
        <span class="n">author</span> <span class="o">=</span> <span class="s2">"Taha Y."</span>
        <span class="n">danabot_samples</span> <span class="o">=</span> <span class="s2">"https://github.com/f0wl/danaConfig"</span>
    <span class="n">strings</span><span class="o">:</span>
        <span class="nv">$s1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="no">D0069006E00690049006E00690074003A004500780063006500700074000000</span><span class="p">}</span>
    <span class="n">condition</span><span class="o">:</span>
        <span class="nv">$s1</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nf">hex</span><span class="p">(</span><span class="s2">"[+] OFFSET "</span><span class="p">,</span> <span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">214</span><span class="p">)</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"[+] C2-#1:"</span><span class="p">)</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-1: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">214</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-2: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">215</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-3: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">216</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-4: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">217</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"[+] C2-#2:"</span><span class="p">)</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-1: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">224</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-2: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">225</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-3: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">226</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-4: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">227</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"[+] C2-#3:"</span><span class="p">)</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-1: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">234</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-2: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">235</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-3: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">236</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-4: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">237</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"[+] C2-#4:"</span><span class="p">)</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-1: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">244</span><span class="p">))</span> 
            <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-2: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">245</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-3: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">246</span><span class="p">))</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"octet-4: "</span><span class="p">,</span><span class="nf">uint8</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">247</span><span class="p">))</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><a href="/assets/img/yara-conf/image1.png" class="popup img-link  shimmer"><img src="/assets/img/yara-conf/image1.png" alt="alt text" loading="lazy"></a></p>

<p>As you can see, the builtin functions could not much help. We are unable to output the data that is at the given offset properly. Also, we are unable to detect and show the strings that are in this sample directly. So, I do not think that anyone will find this method helpful. So, let’s achieve these goals with the help of YARA modules!</p>
<h2 id="yara-modules"><span class="me-2">YARA Modules</span><a href="#yara-modules" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Modules are the method YARA provides for extending its features. They allow you to define data structures and functions which can be used in your rules to express more complex conditions. Check <a href="https://yara.readthedocs.io/en/stable/">the docs</a> for more information.</p>

<h2 id="writing-a-yara-module"><span class="me-2">Writing a YARA Module</span><a href="#writing-a-yara-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Modules are written in C and built into YARA as part of the compiling process. In order to create your own modules you must be familiar with the C programming language and how to configure and build YARA from source code. Check the docs for more information.</p>

<p>YARA modules reside in libyara/modules, it’s recommended to use the module name as the file name for the source file. Then you should include the necessary libraries and defining the module name in the source code.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>    <span class="cp">#include</span> <span class="cpf">&lt;yara/modules.h&gt;</span><span class="cp">
</span>    <span class="cp">#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp">
</span>        
    <span class="cp">#define MODULE_NAME parseutils
</span></pre></td></tr></tbody></table></code></div></div>
<h3 id="used-structures-and-functions-explained"><span class="me-2">Used Structures and Functions Explained</span><a href="#used-structures-and-functions-explained" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>If you check the source code <a href="https://github.com/theatha/YARA_for_config_extraction/blob/main/modules/parseutils/parseutils.c">parseutils.c</a>, you will see some structures and macros in use. I would like to explain what they are used for.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>    <span class="cm">/*
    	YR_SCAN_CONTEXT*: It is used to inspect the file or process memory being scanned.
    	YR_MEMORY_BLOCK*: Represents the memory block.
    	YR_MEMORY_BLOCK_ITERATOR*: Iterator for memory block.
    	YR_OBJECT*: Represents each object declared in the YARA module.
        define_function: Define your function with your desired function name and it's code.
        print_int_data: It is a function identifier.

    */</span>
    <span class="c1">// parseutils.print_int_data(offset,size)</span>
    <span class="n">define_function</span><span class="p">(</span><span class="n">print_int_data</span><span class="p">){</span>
        <span class="n">YR_SCAN_CONTEXT</span><span class="o">*</span> <span class="n">context</span> <span class="o">=</span> <span class="n">yr_scan_context</span><span class="p">();</span>
        <span class="n">YR_MEMORY_BLOCK</span><span class="o">*</span> <span class="n">block</span><span class="p">;</span>
        <span class="n">YR_MEMORY_BLOCK_ITERATOR</span><span class="o">*</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">iterator</span><span class="p">;</span>
        <span class="n">YR_OBJECT</span><span class="o">*</span> <span class="n">module</span> <span class="o">=</span> <span class="n">yr_module</span><span class="p">();</span>
        <span class="cm">/* 
           ... continues below
           ...
        */</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This function takes 2 parameters, <span style="color:green;">offset</span> and <span style="color:green;">size</span>. They can be defined like this:</p>

<p>I used <span style="color:green;">foreach_memory_block</span>  and <span style="color:green;">fetch_data</span> to get data according to the given offset and size.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>    <span class="c1">// define_function(print_int_data) continues</span>
        <span class="c1">// foreach_memory_block macro allows iterating over data sliced into blocks.</span>
        <span class="n">foreach_memory_block</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// fetch_data returns a pointer to the block's data.</span>
            <span class="c1">// Each data in the block comes to the block_data</span>
            <span class="c1">// variable and is thrown into the data array.</span>
            <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">block_data</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">fetch_data</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">offset_0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">offset_0</span><span class="o">+</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
            <span class="kt">uint8_t</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">block_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
            <span class="n">t</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="c1">// convert the data arr to desired char arr </span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
          <span class="n">index</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="s">"%d "</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        
        <span class="c1">// set desired output with set_string</span>
        <span class="n">yr_set_string</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">module</span><span class="p">,</span><span class="s">"str"</span><span class="p">);</span>
        <span class="c1">// return the char arr</span>
        <span class="n">return_string</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Then, running included <a href="https://github.com/VirusTotal/yara/blob/master/build.sh">“build.sh”</a> script in YARA will be compiled with this newly created module.</p>

<h2 id="the-action"><span class="me-2">The Action</span><a href="#the-action" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Let’s see <a href="https://github.com/theatha/YARA_for_config_extraction/tree/main/modules">parseutils</a> in action!</p>

<h3 id="brief-summary-of-danabots-configuration-structure"><span class="me-2">Brief Summary of Danabot’s Configuration Structure</span><a href="#brief-summary-of-danabots-configuration-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><a href="/assets/img/yara-conf/image2.png" class="popup img-link  shimmer"><img src="/assets/img/yara-conf/image2.png" alt="alt text" loading="lazy"></a>
<a href="/assets/img/yara-conf/image3.png" class="popup img-link  shimmer"><img src="/assets/img/yara-conf/image3.png" alt="alt text" loading="lazy"></a></p>

<p>Let’s write a new YARA rule that actually <span style="color:green;">outputs</span>  helpful information this time.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>    <span class="n">import</span> <span class="s2">"console"</span>
    <span class="n">import</span> <span class="s2">"parseutils"</span>
    <span class="n">rule</span> <span class="n">danabot_config_extractor</span> <span class="p">{</span>
    	<span class="n">meta</span><span class="o">:</span>
    		<span class="n">author</span> <span class="o">=</span> <span class="s2">"Taha Y."</span>
    		<span class="n">danabot_samples</span> <span class="o">=</span> <span class="s2">"https://github.com/f0wl/danaConfig"</span>
    	<span class="n">strings</span><span class="o">:</span>
    		<span class="nv">$s1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="no">D0069006E00690049006E00690074003A004500780063006500700074000000</span><span class="p">}</span>
    		<span class="nv">$s2</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="no">E6F6E696F6E</span><span class="p">}</span> <span class="c1">//.onion</span>
    	<span class="n">condition</span><span class="o">:</span>
    		<span class="nv">$s1</span> <span class="k">and</span> <span class="n">console</span><span class="mf">.</span><span class="nf">hex</span><span class="p">(</span><span class="s2">"OFFSET : "</span><span class="p">,</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">224</span><span class="p">)</span> <span class="k">and</span> 
    		 <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"C2-ip1: "</span><span class="p">,</span><span class="n">parseutils</span><span class="mf">.</span><span class="nf">print_int_data</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">214</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="k">and</span>
    		 <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"C2-ip2: "</span><span class="p">,</span><span class="n">parseutils</span><span class="mf">.</span><span class="nf">print_int_data</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">224</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="k">and</span>
    		 <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"C2-ip3: "</span><span class="p">,</span><span class="n">parseutils</span><span class="mf">.</span><span class="nf">print_int_data</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">234</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="k">and</span>
    		 <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"C2-ip4: "</span><span class="p">,</span><span class="n">parseutils</span><span class="mf">.</span><span class="nf">print_int_data</span><span class="p">(</span><span class="o">@</span><span class="n">s1</span><span class="o">+</span><span class="mi">244</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="k">and</span>
    		 <span class="n">console</span><span class="mf">.</span><span class="nb">log</span><span class="p">(</span><span class="s2">"TOR: "</span><span class="p">,</span><span class="n">parseutils</span><span class="mf">.</span><span class="nf">print_string_data</span><span class="p">(</span><span class="o">@</span><span class="n">s2</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span><span class="mi">62</span><span class="p">))</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><a href="/assets/img/yara-conf/image4.png" class="popup img-link  shimmer"><img src="/assets/img/yara-conf/image4.png" alt="alt text" loading="lazy"></a></p>

<h2 id="the-conclusion"><span class="me-2">The Conclusion</span><a href="#the-conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Although the YARA project is mainly used for detection and identifying malware samples, I managed to achieve another goal, which is extracting valuable information. Deep deep down, far far in, I feel that this effort is redundant yet shows how much YARA is flexible.</p>

<p>You can find mentioned resources and one extra yara rule that extracts information from another Danabot variant in <a href="https://github.com/theatha/YARA_for_config_extraction">“YARA_for_config_extraction”</a> repository. If you want to discuss or ask me something, you can reach me from <a href="https://twitter.com/_theatha">twitter</a>.</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Configuration%20Extraction%20With%20Yara%20-%20Theatha%20Technical%20Blog&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FConfiguration-Extraction-with-YARA%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Configuration%20Extraction%20With%20Yara%20-%20Theatha%20Technical%20Blog&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FConfiguration-Extraction-with-YARA%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FConfiguration-Extraction-with-YARA%2F&text=Configuration%20Extraction%20With%20Yara%20-%20Theatha%20Technical%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Setup-a-YARA-Scanner-in-AWS-Lambda/">Setup A Yara Scanner In Aws Lambda</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Configuration-Extraction-with-YARA/">Configuration Extraction With Yara</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->

























            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Older">
      <p>-</p>
    </div>
  

  
    <a
      href="/posts/Setup-a-YARA-Scanner-in-AWS-Lambda/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Setup A Yara Scanner In Aws Lambda</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2024</time>

    
      <a href="https://twitter.com/_theatha">Taha Y.</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->




  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

